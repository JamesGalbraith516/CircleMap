<!DOCTYPE html>
<html>
<head>
  <title>Map with Sidebar and Filters</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Roboto', sans-serif; }

    /* --- Top Panel --- */
    #topPanel {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background: #f5f5f5; display: flex; align-items: center;
      padding: 0 15px; gap: 1rem; z-index: 1000;
      box-sizing: border-box; border-bottom: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      overflow-x: auto; white-space: nowrap;
    }
    #topPanel input, #topPanel select {
      height: 36px; font-size: 14px; padding: 0 0.5rem;
      border-radius: 4px; border: 1px solid #ccc;
      font-family: 'Roboto', sans-serif; background: #fff; color: #333;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    #topPanel input { min-width: 200px; width: 800px; max-width: 100%; }
    #topPanel select { min-width: 180px; }

    #clearFilters {
      height: 36px; padding: 0 12px;
      border: 1px solid #ccc; border-radius: 4px;
      background: #fff; color: #333; cursor: pointer;
      font-size: 14px; font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    #clearFilters:hover { background: #eee; }

    /* --- Sidebar --- */
    #resultsPanel {
      position: fixed; top: 60px; left: 0; width: 350px; bottom: 0;
      overflow-y: auto; background: #f5f5f5; color: #333;
      padding: 0.5rem 1rem 1rem 1rem; font-size: 0.9rem; z-index: 1000;
      box-sizing: border-box; border-right: 1px solid #ccc;
      box-shadow: 2px 0 4px rgba(0,0,0,0.08);
    }
    #resultsPanel h3 {
      margin-top: 0.5rem; margin-bottom: 0.75rem;
    }
    #mapWrapper { position: absolute; top: 60px; left: 350px; right: 0; bottom: 0; }
    #map { width: 100%; height: 100%; }

    /* --- User Cards --- */
    .user-card {
      display: flex; align-items: center; padding: 0.6rem; margin-bottom: 0.6rem;
      background: #fff; border-radius: 6px; cursor: pointer;
      transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .user-card:hover { background: #f1f1f1; }

    .user-circle {
      width: 60px; height: 60px; border-radius: 50%; background: #013b5c; border: 3px solid white;
      color: white; font-weight: bold; font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      margin-right: 0.75rem; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .user-info { display: flex; flex-direction: column; }
    .user-name { font-weight: 500; font-size: 1rem; margin-bottom: 0.1rem; }
    .user-company { font-size: 0.85rem; color: #444; }
    .user-industry { font-size: 0.8rem; color: #666; }
    .user-location { font-size: 0.8rem; color: #666; }

    /* --- Markers --- */
    .letter-marker {
      background: #013b5c; border: 3px solid white; color: white;
      border-radius: 50%; font-weight: bold;
      font-size: 16px; width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    .letter-marker:hover { filter: drop-shadow(0 0 12px #00f); }

    /* --- Clusters --- */
    .custom-cluster {
      background-color: #013b5c; color: white; border: 3px solid white;
      border-radius: 50%; font-weight: bold; font-size: 16px;
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>

<div id="topPanel">
  <input type="text" id="searchInput" placeholder="Search Name">
  <input type="text" id="locationInput" placeholder="Search Location">
  <select id="countryFilter"><option value="">All Countries</option></select>
  <select id="industryFilter"><option value="">All Industries</option></select>
  <button id="clearFilters">Clear All Filters</button>
</div>

<div id="resultsPanel">
  <h3>Users</h3>
  <div id="nearbyList">Click a marker to see users.</div>
</div>

<div id="mapWrapper">
  <div id="map"></div>
</div>

<script>
const map = L.map('map', { zoomControl:true }).setView([54,-98], 4.5); // US & Canada focus
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

const sheetURL='https://docs.google.com/spreadsheets/d/17h6qtv7Kw3ejYyK0hv7XyTUQ1y7KP3wj_w-pG4yNfkM/export?format=csv&gid=1454020769';
let allData=[], markers=[], selectedMarker=null;

const markerCluster = L.markerClusterGroup({
  showCoverageOnHover:false,
  iconCreateFunction: cluster => L.divIcon({
    html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,
    className:'', iconSize:[40,40], iconAnchor:[20,20]
  })
});
map.addLayer(markerCluster);

fetch(sheetURL).then(r=>r.text()).then(csv=>{
  const parsed = Papa.parse(csv,{header:true, skipEmptyLines:true});
  allData = parsed.data;

  const countrySet=new Set(), industrySet=new Set();
  allData.forEach(r=>{
    if(r['Country']) countrySet.add(r['Country']);
    if(r['Industry']) industrySet.add(r['Industry']);
  });

  const countrySelect=document.getElementById('countryFilter');
  Array.from(countrySet).sort().forEach(c=>{
    const o=document.createElement('option'); o.value=c; o.textContent=c; countrySelect.appendChild(o);
  });
  const industrySelect=document.getElementById('industryFilter');
  Array.from(industrySet).sort().forEach(ind=>{
    const o=document.createElement('option'); o.value=ind; o.textContent=ind; industrySelect.appendChild(o);
  });

  updateMap();
  countrySelect.addEventListener('change',updateMap);
  industrySelect.addEventListener('change',updateMap);
  document.getElementById('searchInput').addEventListener('input',updateMap);
  document.getElementById('locationInput').addEventListener('input',updateMap);
  document.getElementById('clearFilters').addEventListener('click',()=>{
    document.getElementById('searchInput').value='';
    document.getElementById('locationInput').value='';
    countrySelect.value='';
    industrySelect.value='';
    updateMap();
  });
  map.on('moveend', updateVisibleUsers);
});

function createLetterMarker(user){
  const firstLetter = user['First Name'] ? user['First Name'][0].toUpperCase() : '?';
  return L.divIcon({ html:`<div class="letter-marker">${firstLetter}</div>`, iconSize:[40,40], iconAnchor:[20,20] });
}

function updateMap(){
  markerCluster.clearLayers(); markers=[]; selectedMarker=null;
  const countryF=document.getElementById('countryFilter').value.toLowerCase();
  const industryF=document.getElementById('industryFilter').value.toLowerCase();
  const nameF=document.getElementById('searchInput').value.toLowerCase();
  const locF=document.getElementById('locationInput').value.toLowerCase();

  allData.forEach(row=>{
    if(countryF && row['Country']?.toLowerCase()!==countryF) return;
    if(industryF && row['Industry']?.toLowerCase()!==industryF) return;
    if(nameF && !(`${row['First Name']} ${row['Last Name']}`.toLowerCase().includes(nameF))) return;
    if(locF && row['City'] && !row['City'].toLowerCase().includes(locF)) return;
    if(!row['Geocode']||!row['Geocode'].includes(',')) return;
    const [lat,lng]=row['Geocode'].split(',').map(Number);
    if(isNaN(lat)||isNaN(lng)) return;

    const marker=L.marker([lat,lng],{icon:createLetterMarker(row)});
    marker.data=row;
    marker.on('mouseover',()=>highlightCard(marker,true));
    marker.on('mouseout',()=>highlightCard(marker,false));
    markers.push(marker);
    markerCluster.addLayer(marker);
  });
  updateVisibleUsers();
}

function getMarkerId(marker){
  const d=marker.data;
  return `${d['First Name']}_${d['Last Name']}_${d['Business Name']||''}`.replace(/\s+/g,'_');
}

function highlightCard(marker,hover){
  const card=document.querySelector(`[data-marker-id="${getMarkerId(marker)}"]`);
  if(card) card.style.backgroundColor = hover ? '#e9f5ff' : '#fff';
}

function updateVisibleUsers(){
  const bounds=map.getBounds();
  const listDiv=document.getElementById('nearbyList'); listDiv.innerHTML='';
  const visible=markers.filter(m=>bounds.contains(m.getLatLng()));
  if(!visible.length){ listDiv.textContent='No users visible on map.'; return; }

  visible.forEach(marker=>{
    const d=marker.data;
    const div=document.createElement('div'); div.className='user-card'; div.dataset.markerId=getMarkerId(marker);
    div.innerHTML=`<div class="user-circle">${d['First Name']?.[0].toUpperCase()||'?'}</div>
      <div class="user-info">
        <div class="user-name">${d['First Name']} ${d['Last Name']}</div>
        <div class="user-company">${d['Business Name']||''}</div>
        <div class="user-industry">${d['Industry']||''}</div>
        <div class="user-location">${d['City']||''}${d['State/Province']?', '+d['State/Province']:''}</div>
      </div>`;
    div.addEventListener('mouseenter',()=>marker.getElement().style.filter='drop-shadow(0 0 12px #00f)');
    div.addEventListener('mouseleave',()=>marker.getElement().style.filter='none');
    listDiv.appendChild(div);
  });
}
</script>
</body>
</html>
