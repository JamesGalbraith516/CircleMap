<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive Map App</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{height:100%;margin:0;font-family:'Roboto',sans-serif;}
#topPanel{position:fixed;top:0;left:0;right:0;height:60px;background:#fff;display:flex;align-items:center;padding:0 15px;gap:1rem;z-index:1000;box-sizing:border-box;border-bottom:1px solid #ccc;box-shadow:0 2px 4px rgba(0,0,0,0.08);overflow-x:auto;white-space:nowrap;}
#topPanel input,#topPanel select,#clearFilters{font-weight:bold;font-family:'Roboto',sans-serif;}
#topPanel input{height:36px;font-size:14px;padding-left:28px;padding-right:0.5rem;border-radius:4px;border:1px solid #ccc;background:#fff;color:#333;box-shadow:0 1px 2px rgba(0,0,0,0.05);min-width:200px;width:400px;max-width:100%;}
#topPanel select{height:36px;font-size:14px;padding:0 0.5rem;padding-right:30px;border-radius:4px;border:1px solid #ccc;background:#f7f9fb;color:#333;min-width:150px;}
#topPanel select option{font-weight:bold;font-family:'Roboto',sans-serif;}
#clearFilters{height:36px;padding:0 12px;border-radius:4px;border:none;background:#66889e;color:white;cursor:pointer;font-size:14px;font-weight:bold;}
#clearFilters:hover{background:#577684;}
.search-wrapper{position:relative;display:inline-block;}
.search-wrapper svg{position:absolute;left:8px;top:50%;transform:translateY(-50%);width:16px;height:16px;fill:#666;pointer-events:none;}
.autocomplete-list{position:absolute;background:#fff;border:1px solid #ccc;border-radius:4px;max-height:150px;overflow-y:auto;z-index:9999;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,0.15);}
.autocomplete-item{padding:6px 8px;cursor:pointer;}
.autocomplete-item:hover{background:#f0f0f0;}

#resultsPanel{position:fixed;top:60px;left:0;width:350px;bottom:0;overflow-y:auto;background:#f7f9fb;color:#333;padding:0.75rem 0.5rem;font-size:0.9rem;z-index:1000;box-sizing:border-box;border-right:1px solid #ccc;box-shadow:2px 0 4px rgba(0,0,0,0.08);display:flex;flex-direction:column;}
#sidebarHeader{display:flex;align-items:center;margin-bottom:0.5rem;justify-content:space-between;}
#sidebarHeader h3{margin:0;font-size:1.5rem;color:#013b5c;margin-right:10px;}
.switch-wrapper{display:flex;align-items:center;}
.switch-wrapper label{margin-right:8px;font-weight:bold;color:#013b5c;}
.switch{position:relative;display:inline-block;width:40px;height:20px;}
.switch input{opacity:0;width:0;height:0;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:20px;}
.slider:before{position:absolute;content:"";height:16px;width:16px;left:2px;bottom:2px;background-color:white;transition:.4s;border-radius:50%;}
input:checked + .slider{background-color:#013b5c;}
input:checked + .slider:before{transform:translateX(20px);}

#nearbyList{display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:flex-start;padding-left:0;padding-right:0;margin:0;box-sizing:border-box;}
#mapWrapper{position:absolute;top:60px;left:350px;right:0;bottom:0;transition:all 0.3s ease;}
#map{width:100%;height:100%;}

.user-card{display:flex;align-items:center;padding:0.6rem;background:#fff;border-radius:6px;cursor:pointer;transition:all 0.2s ease;width:250px;box-shadow:0 1px 2px rgba(0,0,0,0.05);}
.user-card:hover{background:#f1f1f1;}
.user-circle{width:60px;height:60px;border-radius:50%;background:#013b5c;border:3px solid white;color:white;font-weight:bold;font-size:20px;display:flex;align-items:center;justify-content:center;margin-right:0.75rem;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.user-info{display:flex;flex-direction:column;}
.user-name{font-weight:500;font-size:1rem;margin-bottom:0.1rem;}
.user-company{font-size:0.85rem;color:#444;}
.user-industry{font-size:0.8rem;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-industry:hover{cursor:help;}
.user-location{font-size:0.8rem;color:#666;}

.letter-marker{background:#013b5c !important;border:3px solid white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;box-shadow:0 1px 3px rgba(0,0,0,0.25);background-clip:padding-box;background-image:none !important;}
.leaflet-div-icon{background:transparent !important;border:none !important;}
.pulse{animation:pulseAnim 0.6s ease-in-out 2;}
@keyframes pulseAnim{0%{transform:scale(1);}50%{transform:scale(1.4);}100%{transform:scale(1);}}

.custom-cluster{background-color:#013b5c;color:white;border:3px solid white;border-radius:50%;font-weight:bold;font-size:16px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.25);}

@media(max-width:768px){#resultsPanel{width:100%;height:auto;top:60px;position:relative;}#mapWrapper{top:calc(60px+0px);left:0;height:400px;}#nearbyList{justify-content:center;}}
</style>
</head>
<body>

<div id="topPanel">
  <div class="search-wrapper">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C8.01 14 6 11.99 6 9.5S8.01 5 10.5 5 15 7.01 15 9.5 12.99 14 10.5 14z"/></svg>
    <input type="text" id="searchInput" placeholder="Search by Name">
    <div id="nameAutocomplete" class="autocomplete-list"></div>
  </div>
  <div class="search-wrapper">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/></svg>
    <input type="text" id="locationInput" placeholder="Search by Location">
    <div id="locationAutocomplete" class="autocomplete-list"></div>
  </div>
  <select id="countryFilter"><option value="">All Countries</option></select>
  <select id="industryFilter"><option value="">All Industries</option></select>
  <button id="clearFilters">Clear All Filters</button>
</div>

<div id="resultsPanel">
  <div id="sidebarHeader">
    <h3>Users</h3>
    <div class="switch-wrapper">
      <label for="toggleMap">Show Map</label>
      <label class="switch"><input type="checkbox" id="toggleMap" checked><span class="slider"></span></label>
    </div>
  </div>
  <div id="nearbyList">Click a marker to see users.</div>
</div>

<div id="mapWrapper">
  <div id="map"></div>
</div>

<script>
const map=L.map('map',{zoomControl:true}).setView([54,-98],4.5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

const sheetURL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSm2djr9eOyF8SI92KcfrCsrFEcW3dmaStUT4H0Ard8A1BUKKgd08owmHvG6TT7AdfPXB26pJ-Stzjw/pub?gid=528897676&single=true&output=csv';
let allData=[],markers=[],selectedMarker=null;

const markerCluster=L.markerClusterGroup({iconCreateFunction:cluster=>L.divIcon({html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`,className:'',iconSize:L.point(40,40)}),showCoverageOnHover:false});
map.addLayer(markerCluster);

const nameInput=document.getElementById('searchInput');
const locInput=document.getElementById('locationInput');
const nameAuto=document.getElementById('nameAutocomplete');
const locAuto=document.getElementById('locationAutocomplete');

fetch(sheetURL).then(r=>r.text()).then(csv=>{
  const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
  allData=parsed.data;

  const industrySet=new Set(), countrySet=new Set();
  allData.forEach(r=>{if(r['Industry'])industrySet.add(r['Industry']);if(r['Country'])countrySet.add(r['Country']);});

  const industrySelect=document.getElementById('industryFilter');
  Array.from(industrySet).sort().forEach(ind=>{const o=document.createElement('option');o.value=ind;o.textContent=ind;industrySelect.appendChild(o);});
  const countrySelect=document.getElementById('countryFilter');
  Array.from(countrySet).sort().forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;countrySelect.appendChild(o);});

  updateMap();
  industrySelect.addEventListener('change',updateMap);
  countrySelect.addEventListener('change',updateMap);
  document.getElementById('clearFilters').addEventListener('click',()=>{
    nameInput.value=''; locInput.value=''; industrySelect.value=''; countrySelect.value=''; updateMap();
  });
  map.on('moveend',updateVisibleUsers);
});

function createLetterMarker(user){
  const firstLetter=user['First Name']?user['First Name'][0].toUpperCase():'?';
  return L.divIcon({html:`<div class="letter-marker">${firstLetter}</div>`,iconSize:[40,40],iconAnchor:[20,20]});
}

function updateMap(){
  markerCluster.clearLayers(); markers=[]; selectedMarker=null;
  const industryF=document.getElementById('industryFilter').value.toLowerCase();
  const countryF=document.getElementById('countryFilter').value.toLowerCase();

  allData.forEach(row=>{
    if(industryF && row['Industry']?.toLowerCase()!==industryF)return;
    if(countryF && row['Country']?.toLowerCase()!==countryF)return;
    if(!row['Geocode']||!row['Geocode'].includes(','))return;
    let [lat,lng]=row['Geocode'].split(',').map(Number);
    if(isNaN(lat)||isNaN(lng))return;
    lat=parseFloat(lat.toFixed(2)); lng=parseFloat(lng.toFixed(2));

    const marker=L.marker([lat,lng],{icon:createLetterMarker(row)});
    marker.data=row;
    marker.on('mouseover',()=>highlightCard(marker,true));
    marker.on('mouseout',()=>highlightCard(marker,false));
    marker.on('click',()=>{map.setView(marker.getLatLng(),8); pulseMarker(marker);});
    markers.push(marker);
    markerCluster.addLayer(marker);
  });
  updateVisibleUsers();
  setupAutocomplete();
}

function pulseMarker(marker){
  const el=marker.getElement(); if(!el)return;
  el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),1200);
}

function getMarkerId(marker){const d=marker.data;return `${d['First Name']}_${d['Last Name']}_${d['Business Name']||''}`.replace(/\s+/g,'_');}

function highlightCard(marker,hover){
  const card=document.querySelector(`[data-marker-id="${getMarkerId(marker)}"]`);
  if(card)card.style.backgroundColor=hover?'rgba(0,150,205,0.15)':'#fff';
  const el=marker.getElement();
  if(el)el.style.filter=hover?'drop-shadow(0 0 12px #00f)':'drop-shadow(0 0 0 rgba(0,0,0,0))';
}

function updateVisibleUsers(){
  const bounds=map.getBounds();
  const listDiv=document.getElementById('nearbyList'); listDiv.innerHTML='';
  const visible=markers.filter(m=>bounds.contains(m.getLatLng()));
  if(!visible.length){listDiv.textContent='No users visible on map.';return;}

  visible.forEach(marker=>{
    const div=document.createElement('div'); div.className='user-card'; div.dataset.markerId=getMarkerId(marker);
    div.innerHTML=`<div class="user-circle">${marker.data['First Name']?.[0].toUpperCase()||'?'}</div>
      <div class="user-info">
        <div class="user-name">${marker.data['First Name']} ${marker.data['Last Name']}</div>
        <div class="user-company">${marker.data['Business Name']||''}</div>
        <div class="user-industry" title="${marker.data['Industry']||''}">${marker.data['Industry']||''}</div>
        <div class="user-location">${marker.data['City']||''}, ${marker.data['State/Province']||''}, ${marker.data['Country']||''}</div>
      </div>`;
    div.addEventListener('mouseenter',()=>highlightCard(marker,true));
    div.addEventListener('mouseleave',()=>highlightCard(marker,false));
    div.addEventListener('click',()=>{map.setView(marker.getLatLng(),8); pulseMarker(marker);});
    listDiv.appendChild(div);
  });
}

// Autocomplete setup
function setupAutocomplete(){
  setupInputAutocomplete(nameInput,nameAuto,'First Name','Last Name');
  setupInputAutocomplete(locInput,locAuto,'City');
}

function setupInputAutocomplete(input,autoDiv,...fields){
  autoDiv.innerHTML='';
  input.addEventListener('input',()=>{
    autoDiv.innerHTML='';
    const val=input.value.toLowerCase().trim();
    if(!val)return;
    const matches=allData.filter(r=>fields.some(f=>r[f]?.toLowerCase().includes(val)));
    matches.slice(0,5).forEach(r=>{
      const div=document.createElement('div'); div.className='autocomplete-item';
      div.textContent=fields.map(f=>r[f]).join(' ');
      div.addEventListener('click',()=>{
        const marker=markers.find(m=>getMarkerId(m)===getMarkerId({data:r}));
        if(marker){map.setView(marker.getLatLng(),8); pulseMarker(marker); highlightCard(marker,true);}
        input.value=fields.map(f=>r[f]).join(' ');
        autoDiv.innerHTML='';
      });
      autoDiv.appendChild(div);
    });
    const rect=input.getBoundingClientRect();
    autoDiv.style.top=(rect.bottom+window.scrollY)+'px';
    autoDiv.style.left=(rect.left+window.scrollX)+'px';
    autoDiv.style.width=rect.width+'px';
  });
}

// Show Map toggle
const toggleMap=document.getElementById('toggleMap');
toggleMap.addEventListener('change',()=>{
  const mapWrapper=document.getElementById('mapWrapper');
  const resultsPanel=document.getElementById('resultsPanel');
  if(toggleMap.checked){mapWrapper.style.display='block';resultsPanel.style.width='350px';} 
  else{mapWrapper.style.display='none';resultsPanel.style.width='100%';}
});
</script>
</body>
</html>
