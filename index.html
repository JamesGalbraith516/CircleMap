<!DOCTYPE html>
<html>
<head>
  <title>Live Map with Filters</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS + JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:50px; bottom:0; right:0; left:300px; }
    #topPanel {
      position:absolute; top:0; left:0; right:0; height:50px;
      background:#f9f9f9; display:flex; align-items:center; padding:5px;
      z-index:1000;
    }
    #topPanel input, #topPanel select {
      flex:1; margin-right:5px; padding:5px;
    }
    #clearFilters {
      margin-left:auto; padding:5px 10px;
    }
    #sidebar {
      position:absolute; top:50px; left:0; bottom:0; width:300px;
      overflow-y:auto; background:#fff; border-right:1px solid #ccc;
      z-index:1000; padding:10px;
    }
    #resultsPanel h3 {
      margin-bottom:10px;
    }
    .user-card {
      border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:8px;
      cursor:pointer; transition: background 0.2s;
    }
    .user-card.highlight {
      background:rgba(0,150,205,0.15);
    }
    /* Fix white box behind markers */
    .leaflet-div-icon {
      background: transparent !important;
      border: none !important;
    }
    /* Marker + cluster styles */
    .letter-marker, .custom-cluster {
      width:40px; height:40px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-align:center; font-weight:bold; font-size:16px;
      color:white; border:3px solid white;
      background-color:#013b5c;
      transition: filter 0.2s;
    }
    .letter-marker.glow, .custom-cluster.glow {
      filter: drop-shadow(0 0 6px #0096cd);
    }
  </style>
</head>
<body>
  <div id="topPanel">
    <input type="text" id="searchInput" placeholder="Search...">
    <select id="industryFilter">
      <option value="">All Industries</option>
    </select>
    <button id="clearFilters">Clear All Filters</button>
  </div>
  <div id="sidebar">
    <div id="resultsPanel">
      <h3>Users</h3>
      <div id="userCards"></div>
    </div>
  </div>
  <div id="map"></div>

  <script>
    // Init map
    var map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var markers = L.markerClusterGroup();
    var userMarkers = []; // keep refs to all user markers

    // Example data
    var users = [
      {id:1, name:"Alice", industry:"Tech", lat:37.77, lng:-122.41},
      {id:2, name:"Bob", industry:"Finance", lat:40.71, lng:-74.00},
      {id:3, name:"Charlie", industry:"Health", lat:34.05, lng:-118.24}
    ];

    // Add markers
    users.forEach(user=>{
      var icon = L.divIcon({
        html: `<div class="letter-marker">${user.name.charAt(0)}</div>`,
        className: ''
      });
      var marker = L.marker([user.lat, user.lng], {icon:icon});
      marker.userId = user.id;
      userMarkers.push(marker);
      markers.addLayer(marker);
    });

    // Cluster icon
    markers.on('clustermouseover', function (a) {
      // cluster hover handled separately
    });
    markers.on('clustermouseout', function (a) {
      // cluster hover handled separately
    });
    markers.on('clusterclick', function (a) {
      map.fitBounds(a.layer.getBounds());
    });

    map.addLayer(markers);

    // Build user cards
    function renderUserCards(visibleUsers){
      const container=document.getElementById('userCards');
      container.innerHTML='';
      visibleUsers.forEach(user=>{
        var div=document.createElement('div');
        div.className='user-card';
        div.dataset.userId=user.id;
        div.innerHTML=`<strong>${user.name}</strong><br><em>${user.industry}</em>`;
        container.appendChild(div);

        // Hover card -> glow marker
        div.addEventListener('mouseenter', ()=>{
          let marker=userMarkers.find(m=>m.userId===user.id);
          if(marker){
            let el=marker.getElement();
            if(el) el.firstChild.classList.add('glow');

            // if clustered, glow cluster
            let cluster = markers.getVisibleParent(marker);
            if(cluster && cluster._icon){
              cluster._icon.firstChild.classList.add('glow');
            }
          }
        });
        div.addEventListener('mouseleave', ()=>{
          let marker=userMarkers.find(m=>m.userId===user.id);
          if(marker){
            let el=marker.getElement();
            if(el) el.firstChild.classList.remove('glow');

            let cluster = markers.getVisibleParent(marker);
            if(cluster && cluster._icon){
              cluster._icon.firstChild.classList.remove('glow');
            }
          }
        });
      });
    }

    // Hover marker -> highlight card
    function bindMarkerHover(marker){
      marker.on('mouseover', ()=>{
        document.querySelectorAll('.user-card').forEach(c=>{
          if(parseInt(c.dataset.userId)===marker.userId){
            c.classList.add('highlight');
          }
        });
      });
      marker.on('mouseout', ()=>{
        document.querySelectorAll('.user-card').forEach(c=>{
          if(parseInt(c.dataset.userId)===marker.userId){
            c.classList.remove('highlight');
          }
        });
      });
    }
    userMarkers.forEach(bindMarkerHover);

    // Live filter sidebar based on map bounds
    function updateSidebar(){
      var bounds=map.getBounds();
      var visibleUsers=users.filter(user=>bounds.contains([user.lat,user.lng]));
      renderUserCards(visibleUsers);
    }
    map.on('moveend', updateSidebar);

    // Initial render
    updateSidebar();
  </script>
</body>
</html>
