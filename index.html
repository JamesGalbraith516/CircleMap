<!DOCTYPE html>
<html>
<head>
  <title>CircleMap</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
    html, body { height: 100%; margin: 0; font-family: 'Roboto', sans-serif; }
         #topPanel input, #topPanel select, #clearFilters {
            height: 36px; font-size: 14px; padding: 0 0.5rem; border-radius: 4px; border: 1px solid #ccc; font-family: 'Roboto', sans-serif; font-weight: bold;
            background: #f7f9fb;
          }
          
          /* Override background for search inputs to show icons */
          #searchInput, #locationInput {
            background-color: #f7f9fb;
          }
          #searchInput {
            flex: 1;
            min-width: 0;
            order: 1;
            padding-left: 35px; /* Make room for the icon */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
            background-size: 16px 16px;
          }
          #locationInput {
            flex: 1;
            min-width: 0;
            order: 2;
            padding-left: 35px; /* Make room for the icon */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
            background-size: 16px 16px;
          }
          #countryFilter {
            flex: 0 0 auto;
            max-width: 150px;
            order: 3; /* Place country filter third */
          }
          #industryFilter {
            flex: 0 0 auto;
            max-width: 150px;
            order: 4; /* Place industry filter fourth */
          }
          #clearFilters {
            background-color: #66889e; color: white; cursor: pointer;
            flex: 0 0 auto;
            order: 5; /* Place clear button last (far right) */
          }
    #resultsPanel {
      position: fixed; top: 60px; left: 0; width: 350px; bottom: 0;
      overflow-y: auto; background: #f7f9fb; color: #013b5c; padding: 1rem; font-size: 0.9rem; z-index: 1000; box-sizing: border-box;
    }
    #mapWrapper { position: absolute; top: 60px; left: 350px; right: 0; bottom: 0; }
    #map { width: 100%; height: 100%; }

    .user-card {
      display: flex; align-items: center; padding: 0.5rem; margin-bottom: 0.5rem;
      background: #fff; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .user-card:hover { background: rgba(0,150,205,0.15); }
    .user-circle {
      width: 60px; height: 60px; border-radius: 50%; background: #013b5c; border: 3px solid white;
      color: white; font-weight: bold; font-size: 22px; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; flex-shrink: 0;
    }
    .user-info { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
    .user-name, .user-company, .user-industry, .user-location {
      font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .user-name { font-weight: 500; font-size: 1rem;}
    .user-company, .user-industry, .user-location { font-weight: normal; color: #666; }

    .letter-marker, .custom-cluster {
      width: 40px;
      height: 40px;
      border-radius: 50%;         /* perfect circle */
      display: flex;              /* center text */
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      color: white;
      border: 3px solid white;    /* keep your white outline */
      background-color: #013b5c;  /* your existing blue */
    }

    .custom-cluster {
      background-color: #013b5c; color: white; border: 3px solid white; border-radius: 50%;
      text-align: center; font-weight: bold; line-height: 40px; font-size: 16px;
      transition: filter 0.2s;
    }

    /* Keep autocomplete behavior as-is */
    .autocomplete-dropdown {
      position: absolute; background: #fff; border: 1px solid #ccc; z-index: 9999; max-height: 150px; overflow-y: auto; font-family: 'Roboto', sans-serif; font-weight: bold;
    }
    .autocomplete-item { padding: 5px; cursor: pointer; }
    .autocomplete-item:hover { background: #eee; }

    #resultsPanel h3 {
      font-size: 1.5rem;
      margin:0 0 10px 0;  /* keep the padding under title */
      color: #013b5c;
    }

    /* Remove the default white box behind Leaflet div markers (minimal, targeted) */
    .leaflet-div-icon {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }

      @media(max-width:768px){
        #resultsPanel { width: 100%; }
        #mapWrapper { left:0; top:140px; height:calc(100% - 140px); }
        .autocomplete-dropdown { width: calc(100% - 20px); }
        #topPanel {
          flex-wrap: wrap;
          height: auto;
          min-height: 60px;
          padding: 10px 15px;
        }
        #searchInput, #locationInput {
          flex: 0 0 calc(50% - 0.5rem);
          order: 1;
        }
        #countryFilter, #industryFilter {
          flex: 0 0 calc(50% - 0.5rem);
          order: 2;
          margin-bottom: 5px;
        }
        #clearFilters {
          order: 3;
          flex: 0 0 auto;
          margin-bottom: 5px;
        }
}
  </style>
</head>
<body>

<div id="topPanel">
  <input type="text" id="searchInput" placeholder="Search by Name">
  <div id="nameAutocomplete" class="autocomplete-dropdown"></div>
  <input type="text" id="locationInput" placeholder="Search by Location">
  <div id="locationAutocomplete" class="autocomplete-dropdown"></div>
  <select id="countryFilter"><option value="">All Countries</option></select>
  <select id="industryFilter"><option value="">All Industries</option></select>
  <button id="clearFilters">Clear All Filters</button>
</div>

<div id="resultsPanel">
  <h3>Users</h3>
  <div id="nearbyList">Click a marker to see users.</div>
</div>

<div id="mapWrapper">
  <div id="map"></div>
</div>

<script>
const map = L.map('map', { zoomControl:true }).setView([54,-98], 4.5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

const sheetURL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSm2djr9eOyF8SI92KcfrCsrFEcW3dmaStUT4H0Ard8A1BUKKgd08owmHvG6TT7AdfPXB26pJ-Stzjw/pub?gid=528897676&single=true&output=csv';
let allData=[], markers=[], selectedMarker=null;

const markerCluster = L.markerClusterGroup({
  iconCreateFunction: cluster => L.divIcon({ html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`, className:'', iconSize:L.point(40,40) }),
  showCoverageOnHover: false
});
map.addLayer(markerCluster);

const nameInput=document.getElementById('searchInput');
const locationInput=document.getElementById('locationInput');
const nameAuto=document.getElementById('nameAutocomplete');
const locAuto=document.getElementById('locationAutocomplete');

fetch(sheetURL).then(r=>r.text()).then(csv=>{
  const parsed=Papa.parse(csv,{header:true, skipEmptyLines:true});
  allData=parsed.data;

  const industrySet=new Set(), countrySet=new Set();
  allData.forEach(r=>{if(r['Industry'])industrySet.add(r['Industry']);if(r['Country'])countrySet.add(r['Country']);});

  const industrySelect=document.getElementById('industryFilter');
  Array.from(industrySet).sort().forEach(ind=>{const o=document.createElement('option');o.value=ind;o.textContent=ind;industrySelect.appendChild(o);});
  const countrySelect=document.getElementById('countryFilter');
  Array.from(countrySet).sort().forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;countrySelect.appendChild(o);});

  updateMap();
  industrySelect.addEventListener('change',updateMap);
  countrySelect.addEventListener('change',updateMap);
  document.getElementById('clearFilters').addEventListener('click',()=>{
    nameInput.value=''; locationInput.value=''; industrySelect.value=''; countrySelect.value=''; updateMap();
  });
});

function createLetterMarker(user){
  const firstLetter = user['First Name'] ? user['First Name'][0].toUpperCase() : '?';
  return L.divIcon({ html:`<div class="letter-marker">${firstLetter}</div>`, iconSize:[40,40], iconAnchor:[20,20] });
}

function updateMap(){
  markerCluster.clearLayers(); markers=[]; selectedMarker=null;
  const countryF=document.getElementById('countryFilter').value.toLowerCase();
  const industryF=document.getElementById('industryFilter').value.toLowerCase();

  allData.forEach(row=>{
    if(countryF && row['Country']?.toLowerCase()!==countryF) return;
    if(industryF && row['Industry']?.toLowerCase()!==industryF) return;
    if(!row['Geocode']||!row['Geocode'].includes(',')) return;
    let [lat,lng]=row['Geocode'].split(',').map(Number);
    lat=Math.round(lat*100)/100;
    lng=Math.round(lng*100)/100;

    if(isNaN(lat)||isNaN(lng)) return;

    const marker=L.marker([lat,lng],{icon:createLetterMarker(row)});
    marker.data=row;

    // Hover over marker -> highlight its card
    marker.on('mouseover',()=>highlightCard(marker,true));
    marker.on('mouseout',()=>highlightCard(marker,false));

    markers.push(marker);
    markerCluster.addLayer(marker);
  });

  // refresh sidebar to only show what's on the current map view
  updateVisibleUsers();
}

// Build a stable id used for card lookup
function getMarkerId(marker){
  const d=marker.data;
  return `${d['First Name']}_${d['Last Name']}_${d['Business Name']||''}`.replace(/\s+/g,'_');
}

// Card <-> marker glow/highlight (includes cluster glow when applicable)
function highlightCard(marker,hover){
  const card=document.querySelector(`[data-marker-id="${getMarkerId(marker)}"]`);
  if(card) card.style.backgroundColor = hover ? 'rgba(0,150,205,0.15)' : 'transparent';

  // If the marker is clustered at this zoom, glow the cluster; otherwise glow the marker.
  const parent = markerCluster.getVisibleParent(marker);
  if(parent && parent !== marker){
    const clusterEl = parent._icon;
    if(clusterEl) clusterEl.style.filter = hover ? 'drop-shadow(0 0 6px #1893cb)' : '';
  }else{
    const el=marker.getElement && marker.getElement();
    if(el) el.style.filter = hover ? 'drop-shadow(0 0 6px #1893cb)' : '';
  }
}

// Sidebar shows only users visible on the map
function updateVisibleUsers(){
  const bounds=map.getBounds();
  const listDiv=document.getElementById('nearbyList'); listDiv.innerHTML='';
  const visible=markers.filter(m=>bounds.contains(m.getLatLng()));
  if(!visible.length){ listDiv.textContent='No users visible on map.'; return; }

  visible.forEach(marker=>{
    const div=document.createElement('div'); div.className='user-card'; div.dataset.markerId=getMarkerId(marker);
    div.innerHTML=`<div class="user-circle">${marker.data['First Name']?.[0].toUpperCase()||'?'}</div>
      <div class="user-info">
        <div class="user-name" title="${marker.data['First Name']} ${marker.data['Last Name']}">${marker.data['First Name']} ${marker.data['Last Name']}</div>
        <div class="user-company" title="${marker.data['Business Name']||''}">${marker.data['Business Name']||''}</div>
        <div class="user-industry" title="${marker.data['Industry']||''}">${marker.data['Industry']||''}</div>
        <div class="user-location" title="${marker.data['City']||''}, ${marker.data['State/Province']||''}">${marker.data['City']||''}, ${marker.data['State/Province']||''}</div>
      </div>`;

    // Hover over card -> glow marker or its cluster
    div.addEventListener('mouseenter',()=>highlightCard(marker,true));
    div.addEventListener('mouseleave',()=>highlightCard(marker,false));
    listDiv.appendChild(div);
  });
}

// LIVE sidebar updates on map movement/zoom
map.on('moveend', updateVisibleUsers);
map.on('zoomend', updateVisibleUsers);

// Hovering clusters should highlight all their users' cards + glow cluster
markerCluster.on('clustermouseover', e=>{
  const cluster = e.layer;
  const icon = cluster._icon;
  if(icon) icon.style.filter = 'drop-shadow(0 0 6px #1893cb)';
  const children = cluster.getAllChildMarkers();
  children.forEach(m=>{
    const card=document.querySelector(`[data-marker-id="${getMarkerId(m)}"]`);
    if(card) card.style.backgroundColor = 'rgba(0,150,205,0.15)';
  });
});

markerCluster.on('clustermouseout', e=>{
  const cluster = e.layer;
  const icon = cluster._icon;
  if(icon) icon.style.filter = '';
  const children = cluster.getAllChildMarkers();
  children.forEach(m=>{
    const card=document.querySelector(`[data-marker-id="${getMarkerId(m)}"]`);
    if(card) card.style.backgroundColor = 'transparent';
  });
});
</script>
</body>
</html>
