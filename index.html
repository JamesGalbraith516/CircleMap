<!DOCTYPE html>
<html>
<head>
  <title>Map with Sidebar and Filters</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Roboto', sans-serif; }
    #topPanel {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background: #fff; display: flex; align-items: center; padding: 0 15px; gap: 1rem; z-index: 1000;
      box-sizing: border-box; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #topPanel input, #topPanel select, #clearFilters {
      height: 36px; font-size: 14px; padding: 0 0.5rem; border-radius: 4px; border: 1px solid #ccc; font-family: 'Roboto', sans-serif; font-weight: bold;
      background: #f7f9fb;
    }
    #clearFilters {
      background-color: #66889e; color: white; cursor: pointer;
    }
    #resultsPanel {
      position: fixed; top: 60px; left: 0; width: 350px; bottom: 0;
      overflow-y: auto; background: #f7f9fb; color: #013b5c; padding: 1rem; font-size: 0.9rem; z-index: 1000; box-sizing: border-box;
    }
    #mapWrapper { position: absolute; top: 60px; left: 350px; right: 0; bottom: 0; }
    #map { width: 100%; height: 100%; }

    .user-card {
      display: flex; align-items: center; padding: 0.5rem; margin-bottom: 0.5rem;
      background: #fff; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .user-card:hover { background: rgba(0,150,205,0.15); }
    .user-circle {
      width: 60px; height: 60px; border-radius: 50%; background: #013b5c; border: 3px solid white;
      color: white; font-weight: bold; font-size: 22px; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; flex-shrink: 0;
    }
    .user-info { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
    .user-name, .user-company, .user-industry, .user-location {
      font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .user-name { font-weight: 500; }
    .user-company, .user-industry, .user-location { font-weight: normal; color: #666; }

    .letter-marker {
      background: #013b5c; border: 3px solid white; color: white; border-radius: 50%;
      text-align: center; font-weight: bold; font-size: 16px; width: 40px; height: 40px; line-height: 34px;
    }

    .custom-cluster {
      background-color: #013b5c; color: white; border: 3px solid white; border-radius: 50%;
      text-align: center; font-weight: bold; line-height: 40px; font-size: 16px;
    }

    .autocomplete-dropdown {
      position: absolute; background: #fff; border: 1px solid #ccc; z-index: 9999; max-height: 150px; overflow-y: auto; font-family: 'Roboto', sans-serif; font-weight: bold;
    }
    .autocomplete-item { padding: 5px; cursor: pointer; }
    .autocomplete-item:hover { background: #eee; }

    #sidebarHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    #toggleMapWrapper { display:flex; align-items:center; }
    #toggleMap { width: 40px; height: 20px; position: relative; appearance: none; background: #ccc; border-radius: 20px; outline:none; cursor:pointer; margin-left:8px; transition:0.3s; }
    #toggleMap:checked { background: #013b5c; }
    #toggleMap:before { content:""; position:absolute; top:2px; left:2px; width:16px; height:16px; border-radius:50%; background:white; transition:0.3s; }
    #toggleMap:checked:before { transform: translateX(20px); }

    @media(max-width:768px){
      #resultsPanel { width: 100%; }
      #mapWrapper { left:0; top:110px; height:calc(100% - 110px); }
      .autocomplete-dropdown { width: calc(100% - 20px); }
    }
  </style>
</head>
<body>

<div id="topPanel">
  <input type="text" id="searchInput" placeholder="Search by Name">
  <div id="nameAutocomplete" class="autocomplete-dropdown"></div>
  <input type="text" id="locationInput" placeholder="Search by Location">
  <div id="locationAutocomplete" class="autocomplete-dropdown"></div>
  <select id="countryFilter"><option value="">All Countries</option></select>
  <select id="industryFilter"><option value="">All Industries</option></select>
  <button id="clearFilters">Clear All Filters</button>
</div>

<div id="resultsPanel">
  <div id="sidebarHeader">
    <h3>Users</h3>
    <div id="toggleMapWrapper"><label for="toggleMap">Show Map</label><input type="checkbox" id="toggleMap"></div>
  </div>
  <div id="nearbyList">Click a marker to see users.</div>
</div>

<div id="mapWrapper">
  <div id="map"></div>
</div>

<script>
const map = L.map('map', { zoomControl:true }).setView([54,-98], 4.5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

const sheetURL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSm2djr9eOyF8SI92KcfrCsrFEcW3dmaStUT4H0Ard8A1BUKKgd08owmHvG6TT7AdfPXB26pJ-Stzjw/pub?gid=528897676&single=true&output=csv';
let allData=[], markers=[], selectedMarker=null;

const markerCluster = L.markerClusterGroup({
  iconCreateFunction: cluster => L.divIcon({ html:`<div class="custom-cluster">${cluster.getChildCount()}</div>`, className:'', iconSize:L.point(40,40) }),
  showCoverageOnHover: false
});
map.addLayer(markerCluster);

const nameInput=document.getElementById('searchInput');
const locationInput=document.getElementById('locationInput');
const nameAuto=document.getElementById('nameAutocomplete');
const locAuto=document.getElementById('locationAutocomplete');

fetch(sheetURL).then(r=>r.text()).then(csv=>{
  const parsed=Papa.parse(csv,{header:true, skipEmptyLines:true});
  allData=parsed.data;

  const industrySet=new Set(), countrySet=new Set();
  allData.forEach(r=>{if(r['Industry'])industrySet.add(r['Industry']);if(r['Country'])countrySet.add(r['Country']);});

  const industrySelect=document.getElementById('industryFilter');
  Array.from(industrySet).sort().forEach(ind=>{const o=document.createElement('option');o.value=ind;o.textContent=ind;industrySelect.appendChild(o);});
  const countrySelect=document.getElementById('countryFilter');
  Array.from(countrySet).sort().forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;countrySelect.appendChild(o);});

  updateMap();
  industrySelect.addEventListener('change',updateMap);
  countrySelect.addEventListener('change',updateMap);
  document.getElementById('clearFilters').addEventListener('click',()=>{
    nameInput.value=''; locationInput.value=''; industrySelect.value=''; countrySelect.value=''; updateMap();
  });
  map.on('moveend',updateVisibleUsers);
});

function createLetterMarker(user){
  const firstLetter=user['First Name']?user['First Name'][0].toUpperCase():'?';
  return L.divIcon({html:`<div class="letter-marker">${firstLetter}</div>`,iconSize:[40,40],iconAnchor:[20,20]});
}

function updateMap(){
  markerCluster.clearLayers(); markers=[]; selectedMarker=null;
  const industryF=document.getElementById('industryFilter').value.toLowerCase();
  const countryF=document.getElementById('countryFilter').value.toLowerCase();

  allData.forEach(row=>{
    if(industryF && row['Industry']?.toLowerCase()!==industryF)return;
    if(countryF && row['Country']?.toLowerCase()!==countryF)return;
    if(!row['Geocode']||!row['Geocode'].includes(','))return;
    let [lat,lng]=row['Geocode'].split(',').map(Number);
    if(isNaN(lat)||isNaN(lng))return;
    lat=parseFloat(lat.toFixed(2)); lng=parseFloat(lng.toFixed(2));

    const marker=L.marker([lat,lng],{icon:createLetterMarker(row)});
    marker.data=row;
    marker.on('mouseover',()=>highlightCard(marker,true));
    marker.on('mouseout',()=>highlightCard(marker,false));
    marker.on('click',()=>{map.setView(marker.getLatLng(),8); pulseMarker(marker);});
    markers.push(marker);
    markerCluster.addLayer(marker);
  });
  updateVisibleUsers();
  setupAutocomplete();
}

function pulseMarker(marker){
  const el=marker.getElement(); if(!el)return;
  el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),1200);
}

function getMarkerId(marker){const d=marker.data;return `${d['First Name']}_${d['Last Name']}_${d['Business Name']||''}`.replace(/\s+/g,'_');}

function highlightCard(marker,hover){
  const card=document.querySelector(`[data-marker-id="${getMarkerId(marker)}"]`);
  if(card)card.style.backgroundColor=hover?'rgba(0,150,205,0.15)':'#fff';
  const el=marker.getElement();
  if(el)el.style.filter=hover?'drop-shadow(0 0 12px #00f)':'drop-shadow(0 0 0 rgba(0,0,0,0))';
}

function updateVisibleUsers(){
  const bounds=map.getBounds();
  const listDiv=document.getElementById('nearbyList'); listDiv.innerHTML='';
  const visible=markers.filter(m=>bounds.contains(m.getLatLng()));
  if(!visible.length){listDiv.textContent='No users visible on map.';return;}

  visible.forEach(marker=>{
    const div=document.createElement('div'); div.className='user-card'; div.dataset.markerId=getMarkerId(marker);
    div.innerHTML=`<div class="user-circle" title="${marker.data['First Name'] || ''}">${marker.data['First Name']?.[0].toUpperCase()||'?'}</div>
      <div class="user-info">
        <div class="user-name" title="${marker.data['First Name']} ${marker.data['Last Name']}">${marker.data['First Name']} ${marker.data['Last Name']}</div>
        <div class="user-company" title="${marker.data['Business Name']||''}">${marker.data['Business Name']||''}</div>
        <div class="user-industry" title="${marker.data['Industry']||''}">${marker.data['Industry']||''}</div>
        <div class="user-location" title="${marker.data['City']||''}, ${marker.data['State/Province']||''}, ${marker.data['Country']||''}">${marker.data['City']||''}, ${marker.data['State/Province']||''}, ${marker.data['Country']||''}</div>
      </div>`;
    div.addEventListener('mouseenter',()=>highlightCard(marker,true));
    div.addEventListener('mouseleave',()=>highlightCard(marker,false));
    div.addEventListener('click',()=>{map.setView(marker.getLatLng(),8); pulseMarker(marker);});
    listDiv.appendChild(div);
  });
}

// Autocomplete
function setupAutocomplete(){
  setupInputAutocomplete(nameInput,nameAuto,['First Name','Last Name']);
  setupInputAutocomplete(locationInput,locAuto,['City']);
}

function setupInputAutocomplete(input,autoDiv,fields){
  input.addEventListener('input',()=>{
    autoDiv.innerHTML='';
    const val=input.value.toLowerCase().trim();
    if(!val)return;
    const matches=allData.filter(r=>fields.some(f=>r[f]?.toLowerCase().includes(val)));
    matches.slice(0,5).forEach(r=>{
      const div=document.createElement('div'); div.className='autocomplete-item';
      div.textContent=fields.map(f=>r[f]).join(' ');
      div.addEventListener('click',()=>{
        const marker=markers.find(m=>getMarkerId(m)===getMarkerId({data:r}));
        if(marker){map.setView(marker.getLatLng(),8); pulseMarker(marker); highlightCard(marker,true);}
        input.value=fields.map(f=>r[f]).join(' ');
        autoDiv.innerHTML='';
      });
      autoDiv.appendChild(div);
    });
    const rect=input.getBoundingClientRect();
    autoDiv.style.top=(rect.bottom+window.scrollY)+'px';
    autoDiv.style.left=(rect.left+window.scrollX)+'px';
    autoDiv.style.width=rect.width+'px';
  });
}

// Show Map toggle
const toggleMap=document.getElementById('toggleMap');
toggleMap.addEventListener('change',()=>{
  const mapWrapper=document.getElementById('mapWrapper');
  const resultsPanel=document.getElementById('resultsPanel');
  if(toggleMap.checked){mapWrapper.style.display='block';resultsPanel.style.width='350px';} 
  else{mapWrapper.style.display='none';resultsPanel.style.width='100%';}
});
</script>
</body>
</html>
